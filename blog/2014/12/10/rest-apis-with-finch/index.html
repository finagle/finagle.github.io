<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Purely Functional REST APIs with Finch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <link href="/assets/css/bootstrap.css" rel="stylesheet">
    <link href="/assets/css/bootstrap-theme.css" rel="stylesheet">
    <link href="/assets/css/font-awesome.css" rel="stylesheet">
    <link href="/assets/css/syntax.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/favicon.png">
    <link href="../../../../../assets/css/main.css" rel="stylesheet" type="text/css" />

    <!-- JS -->
    <script type="text/javascript" src="/assets/js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="/assets/js/bootstrap.js"></script>

    <link type="application/atom+xml" rel="alternate" href="/blog/feed.xml" />


    <!-- Google Analytics Magic -->
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-39101739-6', 'finagle.github.io');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <!-- navbar excitement -->
    <div class="navbar navbar-custom navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-right navbar-nav">
            <li><a href="https://twitter.github.io/finagle/">Project</a></li>
            <li><a href="https://github.com/finagle/">Ecosystem</a></li>
            <li class="dropdown">
              <a href="https://twitter.github.io/finagle/">Learn more <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu" aria-labelledby="drop1">
                <li role="presentation"><a role="menuitem" tabindex="-1" href="http://twitter.github.io/finagle/guide/">
                  <i class="fa fa-book"></i> User's guide</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="http://twitter.github.io/finagle/guide/Quickstart.html">
                  <i class="fa fa-check-square-o"></i> Quickstart</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://github.com/twitter/finagle/blob/master/ADOPTERS.md">
                  <i class="fa fa-smile-o"></i> Adopters</a>
                </li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="https://github.com/twitter/finagle">Get involved <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu" aria-labelledby="drop1">
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://github.com/twitter/finagle">
                  <i class="fa fa-github-alt"></i> Source</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://github.com/twitter/finagle/blob/master/CONTRIBUTING.md">
                  <i class="fa fa-code-fork"></i> Contributing</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://twitter.com/finagle">
                  <i class="fa fa-twitter"></i> @finagle</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://groups.google.com/forum/#!forum/finaglers">
                  <i class="fa fa-envelope"></i> Mailing list</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="http://stackoverflow.com/questions/tagged/finagle">
                  <i class="fa fa-stack-overflow"></i> Stack Overflow</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://github.com/finagle/finagle.github.io/">
                  <i class="fa fa-pencil"></i> Write a blog post!</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div><!-- /.navbar -->
    <div class="container">
      <div class="row">

<div class="col-md-3">
  <div><a href="/" class="logo"><img src="/assets/img/finagle_logo_small.png" alt="Finagle" /></a></div>
  <div class="meta">
    <!---->
    <div class="author-contact">
      <h4 class="author-name">Vladimir Kostyukov</h4>
      <p class="author-twitter"><a href="https://twitter.com/vkostyukov">@vkostyukov</a></p>
    </div>
    <p><em>Posted December 10, 2014</em></p>
  </div>
  
  <div class="share">
    <span class="social-share-button"><a href="https://twitter.com/share" class="twitter-share-button" data-via="finagle">Tweet</a></span>
    
    <span><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></span>
  </div>
</div>

<div class="post col-md-9">
  <h1>Purely Functional REST APIs with Finch</h1>
  
  <p>At <a href="http://konfettin.ru">Konfettin</a> we decided to build a REST API backend using a <a href="https://twitter.github.io/finagle">Finagle</a> stack. While it&rsquo;s possible to do that using pure Finagle abstractions, we ended up writing the <a href="https://github.com/finagle/finch">Finch</a> library to simplify things and get more suitable building blocks. And it worked well: we shipped the product and got the customers. This library has been running in production for about six months so far and it&rsquo;s pretty stable and well-tested. This post gives an overview of Finch: explains its core design principles and use cases.
</p>

<h2>Overview</h2>

<p>Finch&rsquo;s mission is to provide the developers composable REST API building blocks being as close as possible to the bare metal Finagle API. The killer feature of Finch is purely functional primitives/functions layered on top of the Finagle API. Finch doesn&rsquo;t <em>hide</em> the underlying API, but <em>extends</em> it with new abstractions such as <code>RequestReader</code>, <code>ResponseBuilder</code>, <code>Endpoint</code>, etc. Using Finch means using the power and composability of Finagle within a couple of handy REST-specific types/functions.</p>

<p align="center">
  <img src="https://raw.githubusercontent.com/finagle/finch/master/finch-logo.png" width="360px" style="margin: 1em 0em;"/>
</p>

<h2>Quick Start</h2>

<p>Let&rsquo;s start with writing a simple REST service that greets a user by given <code>name</code> and <code>title</code>.</p>
<pre class="highlight scala"><code><span class="k">import</span> <span class="nn">io.finch._</span>
<span class="k">import</span> <span class="nn">io.finch.request._</span>
<span class="k">import</span> <span class="nn">io.finch.response._</span>

<span class="k">def</span> <span class="n">hello</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Service</span><span class="o">[</span><span class="kt">HttpRequest</span>, <span class="kt">HttpResponse</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">req</span><span class="k">:</span> <span class="kt">HttpRequest</span><span class="o">)</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
    <span class="n">title</span> <span class="k">&lt;-</span> <span class="nc">OptionalParam</span><span class="o">(</span><span class="s">"title"</span><span class="o">)(</span><span class="n">req</span><span class="o">)</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="nc">Ok</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">"greetings"</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="s">"Hello, ${title.getOrElse("")} $name!"</span><span class="o">))</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">endpoint</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Endpoint</span><span class="o">[</span><span class="kt">HttpRequest</span>, <span class="kt">HttpResponse</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">route</span> <span class="k">=</span> <span class="o">{</span>
    <span class="c1">// routes requests like '/hello/Bob?title=Mr.'
</span>    <span class="k">case</span> <span class="nc">Method</span><span class="o">.</span><span class="nc">Get</span> <span class="o">-&gt;</span> <span class="nc">Root</span> <span class="o">/</span> <span class="s">"hello"</span> <span class="o">/</span> <span class="n">name</span> <span class="k">=&gt;</span> <span class="n">hello</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>

<p>The <code>name</code> param is passed as a part of URI, but the <code>title</code> is a regular query string param. The body of <code>hello</code> service is a for-comprehension over the Finagle futures. <code>OptionalParam</code> (a <code>RequestReader</code>) might be treated here as a simple Finagle service that fetches the <em>option</em> of string out of the HTTP request. So it takes an <code>HttpRequest</code> and returns a <code>Future[Option[String]]</code>.</p>

<p>The response is build by <code>ResponseBuilder</code> <code>Ok</code> that builds a succeed <code>HttpResponse</code> with status code two hundred. It takes a JSON object and builds <code>application/json</code> HTTP response. The JSON API is provided by <code>finch-json</code> module, which is shipped along with <code>finch-core</code>.</p>

<h2>Request Reader</h2>

<p>Under the hood, <code>RequestReader</code> is a <a href="https://hackage.haskell.org/package/mtl-1.1.0.2/docs/Control-Monad-Reader.html">reader monad</a>. So, it has a monadic API and we can use a for-comprehension to compose readers together. <code>RequestReader</code> is also a function. So we can pass it a request and get a future of a read value.</p>

<p>Since the request readers read futures they might be chained together with regular Finagle services in a single for-comprehension. Thus, reading the request params is an additional monad-transformation in the program&rsquo;s data flow. This is an extremely useful when a service should fetch and validate the request params before doing a real job and not doing the job at all if the params are not valid. <code>RequestReader</code> might throw a future exception and none of further transformations will be performed. <em>Reader Monad</em> is a well-known abstraction that is heavily used in Finch applications.</p>

<p>The simplified signature of the <code>RequestReader</code> abstraction is similar to <code>Service</code> but with monadic API methods <code>map</code> and <code>flatMap</code>.</p>
<pre class="highlight scala"><code><span class="k">trait</span> <span class="nc">RequestReader</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">req</span><span class="k">:</span> <span class="kt">HttpRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
  <span class="k">def</span> <span class="n">map</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">fn</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">RequestReader</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">flatMap</span><span class="o">(</span><span class="n">fn</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">RequestReader</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">RequestReader</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
<span class="o">}</span>
</code></pre>

<p>In the following example, we define a new request reader <code>pagination</code> that reads a tuple from an <code>HttpRequest</code> with two numbers: <code>offset</code> and <code>limit</code>. These params are optional so we have to provide default values for both of them. We can use request reader as a regular service: it takes an <code>HttpRequest</code> and returns the pagination details in <code>Future[(Int, Int)]</code>.</p>
<pre class="highlight scala"><code><span class="k">import</span> <span class="nn">io.finch.request._</span>

<span class="k">val</span> <span class="n">pagination</span><span class="k">:</span> <span class="kt">RequestReader</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">offset</span> <span class="k">&lt;-</span> <span class="nc">OptionalIntParam</span><span class="o">(</span><span class="s">"offset"</span><span class="o">)</span>
  <span class="n">limit</span> <span class="k">&lt;-</span> <span class="nc">OptionalIntParam</span><span class="o">(</span><span class="s">"limit"</span><span class="o">)</span>
<span class="o">}</span> <span class="k">yield</span> <span class="o">(</span><span class="n">offset</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">math</span><span class="o">.</span><span class="n">min</span><span class="o">(</span><span class="n">limit</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="mi">50</span><span class="o">),</span> <span class="mi">50</span><span class="o">))</span>

<span class="k">val</span> <span class="n">service</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Service</span><span class="o">[</span><span class="kt">HttpRequest</span>, <span class="kt">HttpResponse</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">req</span><span class="k">:</span> <span class="kt">HttpRequest</span><span class="o">)</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
    <span class="o">(</span><span class="n">offsetIt</span><span class="o">,</span> <span class="n">limit</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="n">pagination</span><span class="o">(</span><span class="n">req</span><span class="o">)</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="nc">Ok</span><span class="o">(</span><span class="n">s</span><span class="s">"Fetching items $offset..${offset+limit}"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre>

<p>Here is more complex example: <em>param validation</em>. The <code>RequestReader</code> abstraction may be used for param validation. There is a <code>ValidationRule</code> request reader that doesn&rsquo;t read anything from the request but validates the given predicate and returns <code>Future.Done</code> in case of success. Since, a <code>ValidationRule</code> is an implementation of a <code>RequestReader</code>, it might be chained together with other request readers in the same for-comprehension.</p>
<pre class="highlight scala"><code><span class="k">import</span> <span class="nn">io.finch.request._</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">age</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>

<span class="k">val</span> <span class="n">adult</span><span class="k">:</span> <span class="kt">RequestReader</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">age</span> <span class="k">&lt;-</span> <span class="nc">RequiredIntParam</span><span class="o">(</span><span class="s">"age"</span><span class="o">)</span>
  <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">ValidationRule</span><span class="o">(</span><span class="s">"age"</span><span class="o">,</span> <span class="s">"should be greater then 18"</span><span class="o">)</span> <span class="o">{</span> <span class="n">age</span> <span class="o">&gt;</span> <span class="mi">18</span> <span class="o">}</span>
<span class="o">}</span> <span class="k">yield</span> <span class="nc">User</span><span class="o">(</span><span class="n">age</span><span class="o">)</span>

<span class="k">val</span> <span class="n">req</span><span class="k">:</span> <span class="kt">HttpRequest</span> <span class="o">=</span> <span class="o">???</span>

<span class="k">val</span> <span class="n">user</span><span class="k">:</span> <span class="kt">Json</span> <span class="o">=</span> <span class="n">adult</span><span class="o">(</span><span class="n">req</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">"age"</span> <span class="o">-&gt;</span> <span class="k">_</span><span class="o">.</span><span class="n">age</span><span class="o">)</span> <span class="o">}</span> <span class="n">handle</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">ParamNotFound</span><span class="o">(</span><span class="n">param</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">"error"</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">,</span> <span class="s">"param"</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="n">param</span><span class="o">)</span>
  <span class="k">case</span> <span class="nc">ValidationFailed</span><span class="o">(</span><span class="n">param</span><span class="o">,</span> <span class="n">rule</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">"error"</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">,</span> <span class="s">"param"</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="n">param</span><span class="o">,</span> <span class="s">"rule"</span> <span class="o">-&gt;</span> <span class="n">rule</span><span class="o">)</span>
<span class="o">}</span>
</code></pre>

<p>We have a case class <code>User</code> with only single field <code>age</code>. We can define a new reader <code>adult</code> that reads only adult users. We compose a <code>RequiredIntParam</code> request reader here within a <code>ValidationRule</code>. Then, we fetch the <em>adult</em> user out of the <code>HttpRequest</code> and map it to JSON object. We also have to handle the exceptions of both cases: <code>ParamNotFound</code> and <code>ValidationFailed</code>.</p>

<p>There are plenty of request readers that can read almost everything out of the <code>HttpRequest</code>. There are three common groups of readers:</p>

<ul>
<li><code>OptionalX</code> - reads future <code>Option</code> value from the request;</li>
<li><code>RequiredX</code> - reads either future of value or future exception from the request;</li>
<li><code>ValidationRule</code> - returns <code>Future.Done</code> if the given predicate is true or <code>Future[ValidationFailed]</code> exception;</li>
</ul>

<p>Every <em>required</em> reader has a companion <em>optional</em> one that reads value into a <code>Future[Option[_]]</code>. For example, there are <code>RequiredIntParam</code> and <code>OptionalIntParam</code> readers Finch. Here the list of most popular required readers.</p>

<ul>
<li><code>RequiredParam</code> reads query string param value into a <code>Future[String]</code> or <code>Future[ParamNotFound]</code> exception;</li>
<li><code>RequiredParams</code> reads comma-separated query string param values into a <code>Future[List[_]]</code> or <code>Future[ParamNotFound]</code> exception;</li>
<li><code>RequiredStringBody</code> reads request body into a <code>Future[String]</code> or <code>Future[BodyNotFound]</code> exception;</li>
<li><code>RequiredJsonBody</code> reasd request body into a <code>Future</code> of JSON type defined by implicit <code>DecodeJson</code> value or <code>Future[JsonNotParsed]</code> exception;</li>
<li><code>RequiredHeader</code> reads request header into a <code>Future[String]</code> or <code>Future[HeaderNotFound]</code> exception;</li>
</ul>

<p>For complete reference, see <a href="https://github.com/finagle/finch/blob/master/docs.md#requests">Requests</a> section in the documentation.</p>

<h2>Response Builder</h2>

<p>Responses are much easier. There are plenty of predefined response builders like <code>Ok</code>, <code>NotFound</code> and so on. We can pass it a <code>String</code> and get <code>plain/text</code> HTTP response or we can pass it a JSON object and get <code>application/json</code> HTTP response. We can also add custom headers to the response.</p>
<pre class="highlight scala"><code><span class="k">import</span> <span class="nn">io.finch.response._</span>

<span class="c1">// an empty response with status 200
</span><span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="nc">Ok</span><span class="o">()</span>

<span class="c1">// 'plain/text' response with status 404
</span><span class="k">val</span> <span class="n">b</span> <span class="k">=</span> <span class="nc">NotFound</span><span class="o">(</span><span class="s">"body"</span><span class="o">)</span>

<span class="c1">// 'application/json' response with status 201
</span><span class="k">val</span> <span class="n">c</span> <span class="k">=</span> <span class="nc">Created</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">"id"</span> <span class="o">-&gt;</span> <span class="mi">42</span><span class="o">))</span>

<span class="c1">// an empty response with header
</span><span class="k">val</span> <span class="n">d</span> <span class="k">=</span> <span class="nc">SeeOther</span><span class="o">.</span><span class="n">withHeaders</span><span class="o">(</span><span class="s">"X-Location"</span> <span class="o">-&gt;</span> <span class="s">"Nowhere"</span><span class="o">)()</span>
</code></pre>

<p>For more details, see <a href="https://github.com/finagle/finch/blob/master/docs.md#responses">Responses</a> section in the documentation.</p>

<h2>Endpoint</h2>

<p>Another powerful abstraction in Finch is an <code>Endpoint</code>, which is a <em>composable router</em>. At the high level it might be treated as a usual <code>PartialFuncton</code> from request to service. Endpoints may be converted to Finagle services. And more importantly they can be composed with other building blocks like <em>filters</em>, <em>services</em> or <em>endpoints</em> itself.</p>

<p>We&rsquo;ve seen a pipe (a bang <code>!</code>) operator  before in a quick start example. It&rsquo;s kinda type-safe compositor which can be used with almost everything. It exposes a data flow just like the Linux pipe <code>|</code>. The idea is pretty simple: we can build new endpoints by composing the old ones with either filters or services. It is nothing more than a fancy DSL for developers to allow them to think of the <code>request</code> -&gt; <code>response</code> relationship in terms of flow of data: we just pipe the request through the chain of building blocks and it flows in the exact way we&rsquo;ve written it. Easy-peasy to reason about such code.</p>
<pre class="highlight scala"><code><span class="k">val</span> <span class="n">ab</span><span class="k">:</span> <span class="kt">Filter</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">C</span>, <span class="kt">B</span>, <span class="kt">C</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
<span class="k">val</span> <span class="n">bc</span><span class="k">:</span> <span class="kt">Endpoint</span><span class="o">[</span><span class="kt">B</span>, <span class="kt">C</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
<span class="k">val</span> <span class="n">cd</span><span class="k">:</span> <span class="kt">Service</span><span class="o">[</span><span class="kt">C</span>, <span class="kt">D</span><span class="o">]</span>

<span class="k">val</span> <span class="n">ad1</span><span class="k">:</span> <span class="kt">Endpoint</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">D</span><span class="o">]</span> <span class="k">=</span> <span class="n">ab</span> <span class="o">!</span> <span class="n">bc</span> <span class="o">!</span> <span class="n">cd</span>
<span class="k">val</span> <span class="n">ad2</span><span class="k">:</span> <span class="kt">Endpoint</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">D</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
<span class="k">val</span> <span class="n">ad3</span><span class="k">:</span> <span class="kt">Endpoint</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">D</span><span class="o">]</span> <span class="k">=</span> <span class="n">ad1</span> <span class="n">orElse</span> <span class="n">ad2</span>
</code></pre>

<p>See <a href="https://github.com/finagle/finch/blob/master/docs.md#endpoints">Endpoints</a> section in the documentation.</p>

<h2>JSON</h2>

<p>The Finch library has built-in support for JSON via traits <code>EncodeJson</code> and <code>DecodeJson</code>. All the building blocks in Finch that deal with JSON objects take those traits as implicit values. It makes the JSON dependency pluggable. All we need to do in order to change the JSON backend is to import implicit encoder and decoder into scope and use the new JSON API.</p>

<p>Here is an example of usage of the default JSON implementation from <code>finch-json</code> module.</p>
<pre class="highlight scala"><code><span class="k">import</span> <span class="nn">io.finch.json._</span>       <span class="c1">// import Immutable JSON API from finch-json
</span><span class="k">import</span> <span class="nn">io.finch.json.finch._</span> <span class="c1">// import implciit encoder/decoder for finch-json
</span>
<span class="k">val</span> <span class="n">jsonService</span><span class="k">:</span> <span class="kt">Service</span><span class="o">[</span><span class="kt">HttpRequest</span>, <span class="kt">Json</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
<span class="k">val</span> <span class="n">httpService</span><span class="k">:</span> <span class="kt">Setvice</span><span class="o">[</span><span class="kt">HttpRequest</span>, <span class="kt">HttpResponse</span><span class="o">]</span> <span class="k">=</span> <span class="n">jsonService</span> <span class="o">!</span> <span class="nc">TurnJsonIntoHttp</span><span class="o">[</span><span class="kt">Json</span><span class="o">]</span>
</code></pre>

<p>See <a href="https://github.com/finagle/finch/blob/master/docs.md#json">JSON</a> section in the documentation.</p>

<h2>OAuth2</h2>

<p>There is a separate project <a href="https://github.com/finagle/finagle-oauth2">finagle-oauth2</a>, which is 100% compatible with Finch. It might be used as follows for request authorization.</p>
<pre class="highlight scala"><code><span class="k">import</span> <span class="nn">com.twitter.finagle.oauth2._</span>
<span class="k">import</span> <span class="nn">com.twitter.finagle.oauth2.</span><span class="o">{</span><span class="nc">OAuth2Filter</span><span class="o">,</span> <span class="nc">OAuth2Request</span><span class="o">}</span>

<span class="k">val</span> <span class="n">dataHandler</span><span class="k">:</span> <span class="kt">DataHandler</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>

<span class="k">val</span> <span class="n">auth</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">OAuth2Filter</span><span class="o">(</span><span class="n">dataHandler</span><span class="o">)</span>

<span class="k">val</span> <span class="n">hello</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Service</span><span class="o">[</span><span class="kt">OAuth2Request</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span>, <span class="kt">Response</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">req</span><span class="k">:</span> <span class="kt">OAuth2Request</span><span class="o">[</span><span class="kt">User</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Hello, ${req.authInfo.user}!"</span><span class="o">)</span>
    <span class="nc">Future</span><span class="o">.</span><span class="n">value</span><span class="o">(</span><span class="nc">Response</span><span class="o">())</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">backend</span><span class="k">:</span> <span class="kt">Service</span><span class="o">[</span><span class="kt">Request</span>, <span class="kt">Response</span><span class="o">]</span> <span class="k">=</span> <span class="n">auth</span> <span class="n">andThen</span> <span class="n">hello</span>
</code></pre>

<p>Here <code>hello</code> is a <em>protected</em> service. It takes only authorized requests (request type is <code>OAuth2Request[U]</code>). So, we can rely on the compiler to make sure at compile time that all the services that are supposed to be protected are actually protected. This is a well-known Finagle example of why we need filters and why we love type-safety. We express the business logic in the type system and get a robust application.</p>

<p>For details, see <a href="https://github.com/finagle/finch/blob/master/docs.md#authentication">Authentication</a> section in the documentation.</p>

<h2>Finagle Rocks!</h2>

<p>Finagle itself is a great tool that can easily be adopted outside the Twitter infrastructure. Sometimes it just requires writing a couple of handy libraries on top of it. And that shouldn&rsquo;t be scary for passionate developers.</p>

<h2>Try Finch</h2>

<p>The latest <a href="https://github.com/finagle/finch/releases/tag/0.2.0">release</a> is available on Maven Central:</p>
<pre class="highlight scala"><code><span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
  <span class="s">"com.github.finagle"</span> <span class="o">%%</span> <span class="s">"finch-core"</span> <span class="o">%</span> <span class="s">"0.2.0"</span><span class="o">,</span>
  <span class="s">"com.github.finagle"</span> <span class="o">%%</span> <span class="s">"finch-json"</span> <span class="o">%</span> <span class="s">"0.2.0"</span>
<span class="o">)</span>
</code></pre>

<p>For a complete example of usage, see the <a href="https://github.com/finagle/finch/blob/master/docs.md#demo">demo</a> project (<a href="https://github.com/finagle/finch/blob/master/finch-demo/src/main/scala/io/finch/demo/Main.scala">Main.scala</a>) that is built with the <code>finch-core</code> and <code>finch-json</code> modules.</p>

</div>
</div>

      <hr>
      <!-- footer -->
      <div class="footer pull-right">
        <p>&copy; 2014–2019 <a href="https://twitter.com/">Twitter, Inc.</a> and other contributors
      </div><!-- /footer -->
    </div><!-- /container -->
  </body>
</html>
