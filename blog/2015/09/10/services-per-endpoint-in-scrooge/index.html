<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Services-per-endpoint in Scrooge</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <link href="/assets/css/bootstrap.css" rel="stylesheet">
    <link href="/assets/css/bootstrap-theme.css" rel="stylesheet">
    <link href="/assets/css/font-awesome.css" rel="stylesheet">
    <link href="/assets/css/syntax.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/favicon.png">
    <link href="../../../../../assets/css/main.css" rel="stylesheet" type="text/css" />

    <!-- JS -->
    <script type="text/javascript" src="/assets/js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="/assets/js/bootstrap.js"></script>

    <link type="application/atom+xml" rel="alternate" href="/blog/feed.xml" />


    <!-- Google Analytics Magic -->
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-39101739-6', 'finagle.github.io');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <!-- navbar excitement -->
    <div class="navbar navbar-custom navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-right navbar-nav">
            <li><a href="https://twitter.github.io/finagle/">Project</a></li>
            <li><a href="https://github.com/finagle/">Ecosystem</a></li>
            <li class="dropdown">
              <a href="https://twitter.github.io/finagle/">Learn more <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu" aria-labelledby="drop1">
                <li role="presentation"><a role="menuitem" tabindex="-1" href="http://twitter.github.io/finagle/guide/">
                  <i class="fa fa-book"></i> User's guide</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="http://twitter.github.io/finagle/guide/Quickstart.html">
                  <i class="fa fa-check-square-o"></i> Quickstart</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://github.com/twitter/finagle/blob/master/ADOPTERS.md">
                  <i class="fa fa-smile-o"></i> Adopters</a>
                </li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="https://github.com/twitter/finagle">Get involved <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu" aria-labelledby="drop1">
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://github.com/twitter/finagle">
                  <i class="fa fa-github-alt"></i> Source</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://github.com/twitter/finagle/blob/master/CONTRIBUTING.md">
                  <i class="fa fa-code-fork"></i> Contributing</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://twitter.com/finagle">
                  <i class="fa fa-twitter"></i> @finagle</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://groups.google.com/forum/#!forum/finaglers">
                  <i class="fa fa-envelope"></i> Mailing list</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="http://stackoverflow.com/questions/tagged/finagle">
                  <i class="fa fa-stack-overflow"></i> Stack Overflow</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://github.com/finagle/finagle.github.io/">
                  <i class="fa fa-pencil"></i> Write a blog post!</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div><!-- /.navbar -->
    <div class="container">
      <div class="row">

<div class="col-md-3">
  <div><a href="/" class="logo"><img src="/assets/img/finagle_logo_small.png" alt="Finagle" /></a></div>
  <div class="meta">
    <!---->
    <div class="author-contact">
      <h4 class="author-name">Nik Shkrob</h4>
      <p class="author-twitter"><a href="https://twitter.com/nshkrob">@nshkrob</a></p>
    </div>
    <p><em>Posted September 10, 2015</em></p>
  </div>
  
  <div class="share">
    <span class="social-share-button"><a href="https://twitter.com/share" class="twitter-share-button" data-via="finagle">Tweet</a></span>
    
    <span><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></span>
  </div>
</div>

<div class="post col-md-9">
  <h1>Services-per-endpoint in Scrooge</h1>
  
  <p>We&rsquo;ve released <a href="https://github.com/twitter/scrooge/commit/3fbb635936d82c00456b332647ea9136841f3227">Service-per-endpoint support</a> for Scala Thrift clients generated by Scrooge. This change has been introduced in <a href="https://github.com/twitter/scrooge/releases/tag/scrooge-4.0.0">Scrooge 4.0.0</a>.</p>

<p>This allows the use of Finagle filters with <a href="https://thrift.apache.org/">Thrift</a> services to do retries, timeouts, etc. in a Finagle-idiomatic way. Scrooge generates a <code>Service</code> for each Thrift method, so different filter chains can be built for different methods. Typical examples of this are per-method timeout and retry policies.</p>

<h2>An example</h2>

<p>Here&rsquo;s a Thrift service definition:</p>
<pre class="highlight scala"><code><span class="n">service</span> <span class="nc">LoggerService</span> <span class="o">{</span>
  <span class="n">string</span> <span class="n">log</span><span class="o">(</span><span class="mi">1</span><span class="k">:</span> <span class="kt">string</span> <span class="kt">message</span><span class="o">,</span> <span class="mi">2</span><span class="k">:</span> <span class="kt">i32</span> <span class="kt">logLevel</span><span class="o">);</span>
  <span class="n">i32</span> <span class="n">getLogSize</span><span class="o">();</span>
<span class="o">}</span>
</code></pre>

<p>Before this patch, Scrooge would generate this method-based interface:</p>
<pre class="highlight scala"><code><span class="k">trait</span> <span class="nc">FutureIface</span> <span class="k">extends</span> <span class="nc">LoggerService</span><span class="o">[</span><span class="kt">Future</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">log</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">logLevel</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>
  <span class="k">def</span> <span class="n">getLogSize</span><span class="o">()</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
<span class="o">}</span>
</code></pre>

<p>With the patch, Scrooge also generates the following:</p>
<pre class="highlight scala"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">ServiceIface</span><span class="o">(</span>
  <span class="n">log</span><span class="k">:</span> <span class="kt">Service</span><span class="o">[</span><span class="kt">Log.Args</span>, <span class="kt">Log.Result</span><span class="o">],</span>
  <span class="n">getLogSize</span><span class="k">:</span> <span class="kt">Service</span><span class="o">[</span><span class="kt">GetLogSize.Args</span>, <span class="kt">GetLogSize.Result</span><span class="o">])</span>
</code></pre>

<p>Note that every method in the IDL becomes a <code>Service</code> for the corresponding <code>Args</code> and <code>Result</code> structures. The wrappers are needed to wrap multiple method arguments into one type. </p>

<p>To construct a client, we use <code>newServiceIFace</code>:</p>
<pre class="highlight scala"><code><span class="k">val</span> <span class="n">clientServiceIface</span><span class="k">:</span> <span class="kt">LoggerService.ServiceIface</span> <span class="o">=</span>
  <span class="nc">Thrift</span><span class="o">.</span><span class="n">newServiceIface</span><span class="o">[</span><span class="kt">LoggerService.ServiceIface</span><span class="o">](</span><span class="s">"localhost:1234"</span><span class="o">)</span>
</code></pre>

<p>Because every Thrift method is a Finagle <code>Service</code>, you can decorate them with <code>Filter</code>s:</p>
<pre class="highlight scala"><code><span class="k">val</span> <span class="n">uppercaseFilter</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SimpleFilter</span><span class="o">[</span><span class="kt">Log.Args</span>, <span class="kt">Log.Result</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">req</span><span class="k">:</span> <span class="kt">Log.Args</span><span class="o">,</span> <span class="n">service</span><span class="k">:</span> <span class="kt">Service</span><span class="o">[</span><span class="kt">Log.Args</span>, <span class="kt">Log.Result</span><span class="o">])</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Log.Result</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">uppercaseRequest</span> <span class="k">=</span> <span class="n">req</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">message</span> <span class="k">=</span> <span class="n">req</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">toUpperCase</span><span class="o">)</span>
    <span class="n">service</span><span class="o">(</span><span class="n">uppercaseRequest</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">def</span> <span class="n">timeoutFilter</span><span class="o">[</span><span class="kt">Req</span>, <span class="kt">Rep</span><span class="o">](</span><span class="n">duration</span><span class="k">:</span> <span class="kt">Duration</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">exc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">IndividualRequestTimeoutException</span><span class="o">(</span><span class="n">duration</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">timer</span> <span class="k">=</span> <span class="nc">DefaultTimer</span><span class="o">.</span><span class="n">twitter</span>
  <span class="k">new</span> <span class="nc">TimeoutFilter</span><span class="o">[</span><span class="kt">Req</span>, <span class="kt">Rep</span><span class="o">](</span><span class="n">duration</span><span class="o">,</span> <span class="n">exc</span><span class="o">,</span> <span class="n">timer</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">filteredLog</span> <span class="k">=</span> <span class="n">timeoutFilter</span><span class="o">(</span><span class="mf">2.</span><span class="n">seconds</span><span class="o">)</span> <span class="n">andThen</span>
  <span class="n">uppercaseFilter</span> <span class="n">andThen</span>
  <span class="n">clientServiceIface</span><span class="o">.</span><span class="n">log</span>

<span class="k">val</span> <span class="n">result</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Log.Result</span><span class="o">]</span> <span class="k">=</span> <span class="n">filteredLog</span><span class="o">(</span><span class="nc">Log</span><span class="o">.</span><span class="nc">Args</span><span class="o">(</span><span class="s">"hello"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
</code></pre>

<p>Sometimes different Thrift methods have different latencies; for example the <code>log</code> method typically completes in two second, and the <code>getLogSize</code> method completes in 500 milliseconds. Then we can use a shorter timeout duration for <code>getLogSize</code>:</p>
<pre class="highlight scala"><code><span class="k">val</span> <span class="n">filteredGetLogSize</span> <span class="k">=</span> <span class="n">timeoutFilter</span><span class="o">(</span><span class="mf">500.</span><span class="n">milliseconds</span><span class="o">)</span> <span class="n">andThen</span>
  <span class="n">clientServiceIface</span><span class="o">.</span><span class="n">getLogSize</span>

<span class="k">val</span> <span class="n">size</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">GetLogSize.Result</span><span class="o">]</span> <span class="k">=</span> <span class="n">filteredGetLogSize</span><span class="o">(</span><span class="nc">GetLogSize</span><span class="o">.</span><span class="nc">Args</span><span class="o">())</span>
</code></pre>

<h2>Backwards compatibility</h2>

<p>Existing code works without changes. We don’t plan to deprecate or remove the method-based interfaces.</p>

<p>Additionally, there is a bridge constructor to wrap the old-style method interface around the new service interface.</p>
<pre class="highlight scala"><code><span class="k">val</span> <span class="n">filteredMethodIface</span><span class="k">:</span> <span class="kt">LoggerService</span><span class="o">[</span><span class="kt">Future</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">Thrift</span><span class="o">.</span><span class="n">newMethodIface</span><span class="o">(</span><span class="n">clientServiceIface</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">log</span> <span class="k">=</span> <span class="n">filteredLog</span><span class="o">))</span>

<span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">filteredMethodIface</span><span class="o">.</span><span class="n">log</span><span class="o">(</span><span class="s">"ping"</span><span class="o">,</span> <span class="mi">3</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">println</span><span class="o">))</span>
</code></pre>

<p>This can be used to insert filters into existing Thrift clients.</p>

<p>Please contact the <a href="https://groups.google.com/forum/#!forum/finaglers">Finaglers mailing list</a> with questions or bug reports,
and if you&rsquo;re interested in working on projects like Scrooge, get in touch—the
<a href="https://about.twitter.com/careers/positions?jvi=oLxj1fwm,Job">Core System Libraries team at Twitter is hiring</a>.</p>

</div>
</div>

      <hr>
      <!-- footer -->
      <div class="footer pull-right">
        <p>&copy; 2014–2019 <a href="https://twitter.com/">Twitter, Inc.</a> and other contributors
      </div><!-- /footer -->
    </div><!-- /container -->
  </body>
</html>
