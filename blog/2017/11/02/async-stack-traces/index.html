<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>üõ†Ô∏è Introducing Twitter Futures Capture Points</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <link href="/assets/css/bootstrap.css" rel="stylesheet">
    <link href="/assets/css/bootstrap-theme.css" rel="stylesheet">
    <link href="/assets/css/font-awesome.css" rel="stylesheet">
    <link href="/assets/css/syntax.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/favicon.png">
    <link href="../../../../../assets/css/main.css" rel="stylesheet" type="text/css" />

    <!-- JS -->
    <script type="text/javascript" src="/assets/js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="/assets/js/bootstrap.js"></script>

    <link type="application/atom+xml" rel="alternate" href="/blog/feed.xml" />


    <!-- Google Analytics Magic -->
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-39101739-6', 'finagle.github.io');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <!-- navbar excitement -->
    <div class="navbar navbar-custom navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-right navbar-nav">
            <li><a href="https://twitter.github.io/finagle/">Project</a></li>
            <li><a href="https://github.com/finagle/">Ecosystem</a></li>
            <li class="dropdown">
              <a href="https://twitter.github.io/finagle/">Learn more <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu" aria-labelledby="drop1">
                <li role="presentation"><a role="menuitem" tabindex="-1" href="http://twitter.github.io/finagle/guide/">
                  <i class="fa fa-book"></i> User's guide</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="http://twitter.github.io/finagle/guide/Quickstart.html">
                  <i class="fa fa-check-square-o"></i> Quickstart</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://github.com/twitter/finagle/blob/master/ADOPTERS.md">
                  <i class="fa fa-smile-o"></i> Adopters</a>
                </li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="https://github.com/twitter/finagle">Get involved <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu" aria-labelledby="drop1">
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://github.com/twitter/finagle">
                  <i class="fa fa-github-alt"></i> Source</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://github.com/twitter/finagle/blob/master/CONTRIBUTING.md">
                  <i class="fa fa-code-fork"></i> Contributing</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://twitter.com/finagle">
                  <i class="fa fa-twitter"></i> @finagle</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://groups.google.com/forum/#!forum/finaglers">
                  <i class="fa fa-envelope"></i> Mailing list</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="http://stackoverflow.com/questions/tagged/finagle">
                  <i class="fa fa-stack-overflow"></i> Stack Overflow</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://github.com/finagle/finagle.github.io/">
                  <i class="fa fa-pencil"></i> Write a blog post!</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div><!-- /.navbar -->
    <div class="container">
      <div class="row">

<div class="col-md-3">
  <div><a href="/" class="logo"><img src="/assets/img/finagle_logo_small.png" alt="Finagle" /></a></div>
  <div class="meta">
    <!---->
    <div class="author-contact">
      <h4 class="author-name">Stefan Lance</h4>
      <p class="author-twitter"><a href="https://twitter.com/stefan_lance">@stefan_lance</a></p>
    </div>
    <p><em>Posted November  2, 2017</em></p>
  </div>
  
  <div class="share">
    <span class="social-share-button"><a href="https://twitter.com/share" class="twitter-share-button" data-via="finagle">Tweet</a></span>
    
    <span><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></span>
  </div>
</div>

<div class="post col-md-9">
  <h1>üõ†Ô∏è Introducing Twitter Futures Capture Points</h1>
  
  <p>If you&rsquo;ve ever tried to debug asynchronous code written with Twitter <a href="https://github.com/twitter/util/blob/develop/util-core/src/main/scala/com/twitter/util/Future.scala"><code>Future</code></a>s, 
you may have found that the stack trace isn&rsquo;t always helpful. The stack trace
at a given point in the program includes the active stack frames and thus shows
the chain of function calls that led up to that point. Since asynchronous
execution causes different parts of a program to have their stack traces chopped
up, the stack trace often shows unexpected internal library calls and is missing
the causality developers are used to from synchronous code. As a result, the
context leading to the current stack frame is lost.</p>

<p>IntelliJ 2017.1 included a feature called <a href="https://blog.jetbrains.com/idea/2017/02/intellij-idea-2017-1-eap-extends-debugger-with-async-stacktraces/">Capture Points</a>.
This feature lets us stitch together stack frames so that the order of functions
in the stack trace respects the order in which they were called.</p>

<p>Our summer intern, <a href="https://twitter.com/McKardah">Haggai Kaunda</a>, wrote capture
points specific to Twitter <a href="https://github.com/twitter/util/blob/develop/util-core/src/main/scala/com/twitter/util/Future.scala"><code>Future</code></a>s 
(thanks, Haggai!). Using these can make debugging asynchronous code written
with Twitter <code>Future</code>s simpler by providing more informative stack traces.</p>

<p>Note that as of November 2017, the capture points are guaranteed to work with
only Scala 2.11. We are not working on capture points for 2.12 at this time;
if you would like to help make this feature available for more users, you can
submit a pull request on <a href="https://github.com/twitter/util">util&rsquo;s GitHub repo</a>.</p>

<p>To start using, you can grab the capture points XML file <a href="https://raw.githubusercontent.com/twitter/util/develop/util-intellij/src/main/resources/util-intellij/TwitterFuturesCapturePoints.xml">directly from GitHub</a>,
and after our next release it will be available as an artifact published to
Maven Central.</p>

<h2>Setup</h2>

<p>The capture points are defined in <a href="http://github.com/twitter/util/util-intellij/src/main/resources/util-intellij/TwitterFuturesCapturePoints.xml">TwitterFuturesCapturePoints.xml</a>.
To import them into IntelliJ,</p>

<ol>
<li>Open IntelliJ. In the menu bar, click IntelliJ IDEA &gt; Preferences.</li>
<li>Navigate to Build, Execution, Deployment &gt; Debugger &gt; Async Stacktraces.</li>
<li>Click the Import icon on the bottom bar. Find the XML file and click OK.</li>
</ol>

<h2>Use</h2>

<p>Set a breakpoint where you wish to see the stack trace, debug your code, and 
look at the &ldquo;Frames&rdquo; tab in the Debugger. Any asynchronous calls in the stack
trace will appear in logical order. If you wish to clean up the stack trace,
click the funnel icon in the top right, &ldquo;Hide Frames from Libraries&rdquo;.</p>

<h2>Example</h2>

<p>We will illustrate how to use the capture points to assist with debugging with a
<a href="https://github.com/twitter/util/blob/develop/util-intellij/src/test/scala/com/twitter/util/capturepoints/Demo.scala">small example</a>
written by <a href="https://twitter.com/kevino">Kevin Oliver</a> (thanks, Kevin!).</p>

<p>A brief explanation of this test: the test passes a <a href="https://github.com/twitter/util/blob/develop/util-core/src/main/scala/com/twitter/util/Promise.scala"><code>Promise[Int]</code></a>
through three methods and then sets the <code>Promise</code>‚Äôs value in a <code>futurePool</code>.
The calls are asynchronous, but the logical flow of the test is as follows:</p>

<ol>
<li><code>test</code> block calls <code>someBusinessLogic</code></li>
<li><code>someBusinessLogic</code> calls <code>moreBusinessLogic</code></li>
<li><code>moreBusinessLogic</code> calls <code>lordBusinessLogic</code></li>
<li><code>lordBusinessLogic</code> waits for the <code>Promise</code>‚Äôs value to be set</li>
<li>The <code>Promise</code>‚Äôs value is set in the test block (this could happen at any
time; it is not necessarily step number 5)</li>
<li><code>lordBusinessLogic</code> returns</li>
<li><code>test</code>‚Äôs <code>result</code> variable is <code>4</code>, and the test passes</li>
</ol>

<p>Suppose we wish to inspect the stack trace from inside <code>lordBusinessLogic</code>. If 
we set a breakpoint at line 47 and then debug the test in IntelliJ with the
capture points disabled, we see the following stack trace:</p>
<pre class="highlight plaintext"><code>apply$mcVI$sp:47, Demo$$anonfun$lordBusinessLogic$1
apply:1820, Future$$anonfun$onSuccess$1
apply:205, Promise$Monitored
run:532, Promise$$anon$7
run:198, LocalScheduler$Activation
submit:157, LocalScheduler$Activation
submit:274, LocalScheduler
submit:109, Scheduler$
runq:522, Promise
updatelfEmpty:880, Promise
update:859, Promise
setValue:835, Promise
apply$mcV$sp:20, Demo$$anonfun$3$$anonfun$apply$1
apply:15, Try$
run:140, ExecutorServiceFuturePool$$anon$4
</code></pre>

<p>The library calls in the stack trace do not help us understand our code. If we
enable the capture points and again debug the test, we see the following stack
trace:</p>
<pre class="highlight plaintext"><code>apply$mcVI$sp:47, Demo$$anonfun$lordBusinessLogic$1
apply:1820, Future$$anonfun$onSuccess$1
onSuccess:1819, Future
lordBusinessLogic:42, Demo
moreBusinessLogic:38, Demo
someBusinessLogic:31, Demo
apply:17, Demo$$anonfun$3
</code></pre>

<p>This is much cleaner and it includes only calls to functions we wrote. It lets
us clearly see that the test block called <code>someBusinessLogic</code>, that
<code>someBusinessLogic</code> called <code>moreBusinessLogic</code>, and that <code>moreBusinessLogic</code>
called <code>lordBusinessLogic</code>.</p>

<h2>That&rsquo;s all!</h2>

<p>Please let us know if you have any questions via <a href="http://twitter.com/finagle">@finagle</a>,
the <a href="https://groups.google.com/forum/#!forum/finaglers">Finaglers mailing list</a>, or
<a href="https://gitter.im/twitter/finagle">chat</a>.</p>

<p>Happy debugging!</p>

</div>
</div>

      <hr>
      <!-- footer -->
      <div class="footer pull-right">
        <p>&copy; 2014‚Äì2019 <a href="https://twitter.com/">Twitter, Inc.</a> and other contributors
      </div><!-- /footer -->
    </div><!-- /container -->
  </body>
</html>
