<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Netty 4 support in Finagle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <link href="/assets/css/bootstrap.css" rel="stylesheet">
    <link href="/assets/css/bootstrap-theme.css" rel="stylesheet">
    <link href="/assets/css/font-awesome.css" rel="stylesheet">
    <link href="/assets/css/syntax.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/favicon.png">
    <link href="../../../../../assets/css/main.css" rel="stylesheet" type="text/css" />

    <!-- JS -->
    <script type="text/javascript" src="/assets/js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="/assets/js/bootstrap.js"></script>

    <link type="application/atom+xml" rel="alternate" href="/blog/feed.xml" />


    <!-- Google Analytics Magic -->
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-39101739-6', 'finagle.github.io');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <!-- navbar excitement -->
    <div class="navbar navbar-custom navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-right navbar-nav">
            <li><a href="https://twitter.github.io/finagle/">Project</a></li>
            <li><a href="https://github.com/finagle/">Ecosystem</a></li>
            <li class="dropdown">
              <a href="https://twitter.github.io/finagle/">Learn more <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu" aria-labelledby="drop1">
                <li role="presentation"><a role="menuitem" tabindex="-1" href="http://twitter.github.io/finagle/guide/">
                  <i class="fa fa-book"></i> User's guide</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="http://twitter.github.io/finagle/guide/Quickstart.html">
                  <i class="fa fa-check-square-o"></i> Quickstart</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://github.com/twitter/finagle/blob/master/ADOPTERS.md">
                  <i class="fa fa-smile-o"></i> Adopters</a>
                </li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="https://github.com/twitter/finagle">Get involved <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu" aria-labelledby="drop1">
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://github.com/twitter/finagle">
                  <i class="fa fa-github-alt"></i> Source</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://github.com/twitter/finagle/blob/master/CONTRIBUTING.md">
                  <i class="fa fa-code-fork"></i> Contributing</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://twitter.com/finagle">
                  <i class="fa fa-twitter"></i> @finagle</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://groups.google.com/forum/#!forum/finaglers">
                  <i class="fa fa-envelope"></i> Mailing list</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="http://stackoverflow.com/questions/tagged/finagle">
                  <i class="fa fa-stack-overflow"></i> Stack Overflow</a>
                </li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://github.com/finagle/finagle.github.io/">
                  <i class="fa fa-pencil"></i> Write a blog post!</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div><!-- /.navbar -->
    <div class="container">
      <div class="row">

<div class="col-md-3">
  <div><a href="/" class="logo"><img src="/assets/img/finagle_logo_small.png" alt="Finagle" /></a></div>
  <div class="meta">
    <!---->
    <div class="author-contact">
      <h4 class="author-name">Vladimir Kostyukov</h4>
      <p class="author-twitter"><a href="https://twitter.com/vkostyukov">@vkostyukov</a></p>
    </div>
    <p><em>Posted February  6, 2017</em></p>
  </div>
  
  <div class="share">
    <span class="social-share-button"><a href="https://twitter.com/share" class="twitter-share-button" data-via="finagle">Tweet</a></span>
    
    <span><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></span>
  </div>
</div>

<div class="post col-md-9">
  <h1>Netty 4 support in Finagle</h1>
  
  <p>It&rsquo;s been quite a while since the <a href="http://finagle.github.io/blog/2014/10/20/upgrading-finagle-to-netty-4/">Netty 4 migration in Finagle</a> was initially
announced. We&rsquo;ve travelled a long way and are happy to announce that there is now (as of
<a href="https://github.com/twitter/finagle/releases/tag/finagle-6.42.0">Finagle 6.42</a>) support for Netty 4 transports in most of the protocols: Thrift, ThriftMux,
Memcached, MySQL, Kestrel, and Redis. Both HTTP/1.1 and HTTP/2 are coming soon!</p>

<h2>How to enable Netty 4?</h2>

<p>While we have not yet defaulted to Netty 4, we&rsquo;ve been running it in production for several months
and have gained enough confidence to publicize the availability of the alternative transports in
Finagle.</p>

<p>We encourage Finagle users to try out the new Netty 4 transports for their protocols and jump on the
fast track to upcoming changes around resiliency (think of HTTP/2) and performance (think of a
reduced allocation profile and better threading model in Netty 4).</p>

<p>To switch the transport over to Netty 4 supply the following command line flag:</p>
<pre class="highlight plaintext"><code>-Dcom.twitter.finagle.toggle.flag.overrides=com.twitter.$protocol.UseNetty4=1.0
</code></pre>

<p>Where <code>$protocol</code> is one of the following: <code>mux</code> (use this for ThriftMux), <code>thrift</code>, <code>mysql</code>,
<code>memcached</code>, <code>kestrel</code>.</p>

<p>This command line flag overrides <a href="https://twitter.github.io/finagle/guide/Configuration.html#feature-toggles">a feature toggle</a> that is evaluated at application
startup and is <em>global for all clients/servers running on the same JVM instance</em>.</p>

<p>Note that Netty 4 is already enabled by default in <code>finagle-redis</code> so no need for an extra CLI flag.</p>

<h2>What about HTTP/1.1?</h2>

<p>HTTP/1.1 on Netty 4 is still a work in progress. There are known limitations for HTTP clients, but
we&rsquo;ve been successfully running <code>finagle-http</code> servers with Netty 4 in production for several weeks
and on <a href="https://github.com/twitter/twitter-server">TwitterServer</a>&rsquo;s admin interface for several months.</p>

<p>We feel confident in HTTP/1.1 servers running Netty 4 and encourage you to migrate now using the
toggle override. Please note that this will also switch HTTP clients running in the same JVM
process over to Netty 4, which we do not recommend at this point.</p>
<pre class="highlight plaintext"><code>-Dcom.twitter.finagle.toggle.flag.overrides=com.twitter.http.UseNetty4=1.0
</code></pre>

<h2>What about HTTP/2?</h2>

<p>HTTP/2 (i.e., <code>finagle-http2</code>) should be considered beta as there are known issues with the ALPN
support. We&rsquo;re hoping to roll out a feature-complete HTTP/2 implementation in the next couple of
months. In the meantime, HTTP/2 support can be experimentally enabled on any Finagle HTTP client
or server as shown below.</p>
<pre class="highlight scala"><code><span class="k">import</span> <span class="nn">com.twitter.finagle.Http</span>

<span class="k">val</span> <span class="n">client</span> <span class="k">=</span> <span class="nc">Http</span><span class="o">.</span><span class="n">client</span>
  <span class="o">.</span><span class="n">configured</span><span class="o">(</span><span class="nc">Http</span><span class="o">.</span><span class="nc">Http2</span><span class="o">)</span>
  <span class="o">.</span><span class="n">newService</span><span class="o">(</span><span class="s">"www.example.com:80"</span><span class="o">)</span>
</code></pre>

<h2>What&rsquo;s next?</h2>

<p>We&rsquo;re quite optimistic about enabling Netty 4 by default in the next couple of months. Even though
we&rsquo;re not there yet, we feel very proud of the work we&rsquo;ve done and the progress we&rsquo;ve made. It took
us several years of engineering effort to be able to start serving Netty 4 traffic in production.</p>

<h2>Where to report problems?</h2>

<p>Please file a <a href="https://github.com/twitter/finagle/issues">Github issue</a> if anything doesn&rsquo;t look right when Netty 4 is enabled.</p>

</div>
</div>

      <hr>
      <!-- footer -->
      <div class="footer pull-right">
        <p>&copy; 2014–2019 <a href="https://twitter.com/">Twitter, Inc.</a> and other contributors
      </div><!-- /footer -->
    </div><!-- /container -->
  </body>
</html>
